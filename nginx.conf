# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream dashboard {
        server edirom-online-backend:8080;
    }

    upstream edirom {
        server edirom-online-frontend:80;
    }

    upstream digilib {
        server digilib:8080;
    }

    server {
        listen 80;
        server_name localhost;

        # Dashboard (eXist-db Backend) erreichbar unter http://localhost/dashboard
        location /dashboard {
            return 301 /dashboard/;
        }
        
        location /dashboard/ {
            proxy_pass http://dashboard/exist/apps/dashboard/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Für eXist-db WebDAV Support
            proxy_set_header X-Forwarded-Host $host;
        }

        # Zusätzlich: Falls jemand direkt auf /exist zugreift
        location /exist/ {
            proxy_pass http://dashboard/exist/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Edirom Frontend erreichbar unter http://localhost/edirom
        location /edirom/ {
            proxy_pass http://edirom/;  # Der Slash am Ende ist wichtig!
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Digilib erreichbar unter http://localhost/digilib
        location /digilib/ {
            proxy_pass http://digilib/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Standard-Route - zeigt eine Übersichtsseite
        location / {
            return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>Edirom Services</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .service { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .service a { text-decoration: none; color: #007bff; font-weight: bold; }
        .service a:hover { color: #0056b3; }
        .service p { margin: 5px 0; color: #666; }
        .port-info { font-size: 12px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Edirom Services</h1>
        
        <div class="service">
            <a href="/dashboard/">Dashboard (eXist-db)</a>
            <p>Backend Database und Administration</p>
            <div class="port-info">Ursprünglich: Port 8080</div>
        </div>
        
        <div class="service">
            <a href="/edirom/">Edirom Online</a>
            <p>Edirom Digital Edition Frontend</p>
            <div class="port-info">Ursprünglich: Port 8089</div>
        </div>
        
        <div class="service">
            <a href="/digilib/">Digilib</a>
            <p>Max Reger Institut Digilib Image Server</p>
            <div class="port-info">MRI Digilib v2.12.4</div>
        </div>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }
    }
}
